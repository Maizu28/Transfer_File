<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uploader dengan Drag & Drop</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f4f4f9; color: #333; margin: 0; padding: 2rem; }
        .container { max-width: 800px; margin: auto; background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1, h2 { color: #1a237e; }
        h3 { border-bottom: 2px solid #e0e0e0; padding-bottom: 8px; margin-top: 2rem; color: #3f51b5; }
        .upload-form {
            margin-bottom: 2rem; padding: 2rem; border: 2px dashed #3949ab; border-radius: 8px; background-color: #e8eaf6;
            text-align: left; /* <-- PERUBAHAN DARI 'center' MENJADI 'left' */
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .upload-form.drag-over {
            background-color: #c5cae9;
            border-color: #1a237e;
        }
        .upload-form p { margin-top: 0; }
        input[type="file"] { display: block; margin-bottom: 1rem; }
        button { background-color: #3949ab; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; }
        button:hover { background-color: #1a237e; }
        button:disabled { background-color: #9fa8da; cursor: not-allowed; }
        .file-list { list-style: none; padding: 0; }
        .file-list li { background-color: #f1f1f1; padding: 10px; border-radius: 5px; margin-bottom: 8px; }
        .file-list a { text-decoration: none; color: #0d47a1; font-weight: 500; word-break: break-all; }
        .file-list a:hover { text-decoration: underline; }
        .qr-section { text-align: center; padding: 1rem; background-color: #fafafa; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 2rem; }
        .qr-section img { width: 150px; height: 150px; margin: auto; display: block; }
        .qr-section code { background-color: #eee; padding: 2px 6px; border-radius: 4px; }
        
        .upload-status {
            margin-top: 1rem;
            text-align: left;
        }
        #fileNameDisplay { font-weight: bold; color: #333; }
        #fileCountDisplay { font-size: 0.9em; color: #666; margin-bottom: 5px; }
        .progress-container { width: 100%; background-color: #e0e0e0; border-radius: 5px; }
        .progress-bar { width: 0%; height: 24px; background-color: #4caf50; border-radius: 5px; text-align: center; line-height: 24px; color: white; transition: width 0.1s linear; }
    </style>
</head>
<body>
    <div class="container">
        <div class="qr-section">
            <h4>üì± Akses dari Perangkat Lain</h4>
            <p>Scan QR code ini dengan ponsel Anda yang terhubung ke jaringan Wi-Fi yang sama.</p>
            <img src="{{ url_for('static', filename='local_qr.png') }}" alt="QR Code untuk Akses Lokal">
            <p><small>Atau buka alamat: <code>{{ local_url }}</code></small></p>
        </div>

        <h1>üöÄ Upload File</h1>
        <p>Kamu bisa upload file banyak sekaligus, Jenis file yang berbentuk jpg/jpeg akan di convert dalam bentuk png, upload file ini tidak menurunkan kualitas dan tidak dikenakan batas pengiriman.</p>
        
        <form id="uploadForm" class="upload-form" method="post" enctype="multipart/form-data">
            <p>Seret & letakkan file di sini atau</p>
            <input type="file" id="fileInput" name="file" required multiple>
            <button type="submit" id="submitButton">Unggah File</button>
            <div id="uploadStatus" class="upload-status" style="display: none;">
                <p id="fileNameDisplay"></p>
                <p id="fileCountDisplay"></p>
                <div class="progress-container">
                    <div id="progressBar" class="progress-bar">0%</div>
                </div>
            </div>
        </form>

        <h2>Daftar File Tersimpan</h2>
        {% if categorized_files %}
            {% for category, files in categorized_files.items() %}
                <h3>
                    {% if category == 'foto' %}üñºÔ∏è
                    {% elif category == 'video' %}üé¨
                    {% elif category == 'documen' %}üìÑ
                    {% elif category == 'compress' %}üì¶
                    {% else %}üìé
                    {% endif %}
                    {{ category.capitalize() }}
                </h3>
                <ul class="file-list">
                    {% for file in files %}
                    <li>
                        <a href="{{ url_for('uploaded_file', category=category, filename=file) }}" target="_blank">{{ file }}</a>
                    </li>
                    {% endfor %}
                </ul>
            {% endfor %}
        {% else %}
            <p>Belum ada file yang diunggah.</p>
        {% endif %}
    </div>

    <script>
        const form = document.getElementById('uploadForm');
        const fileInput = document.getElementById('fileInput');
        const submitButton = document.getElementById('submitButton');
        const uploadStatus = document.getElementById('uploadStatus');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        const fileCountDisplay = document.getElementById('fileCountDisplay');
        const progressBar = document.getElementById('progressBar');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            form.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            form.addEventListener(eventName, () => form.classList.add('drag-over'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            form.addEventListener(eventName, () => form.classList.remove('drag-over'), false);
        });

        form.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            fileInput.files = files;
            
            if (files.length > 0) {
                fileNameDisplay.textContent = `${files.length} file dipilih. Klik tombol unggah untuk memulai.`;
                fileCountDisplay.textContent = '';
                uploadStatus.style.display = 'block';
            }
        }

        async function uploadFileSequentially(files, index) {
            if (index >= files.length) {
                fileNameDisplay.textContent = 'Semua file berhasil diunggah!';
                fileCountDisplay.textContent = '';
                progressBar.style.backgroundColor = '#28a745';
                setTimeout(() => window.location.reload(), 1500);
                return;
            }
            const file = files[index];
            const totalFiles = files.length;
            fileNameDisplay.textContent = `Mengunggah: ${file.name}`;
            fileCountDisplay.textContent = `File ${index + 1} dari ${totalFiles}`;
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
            progressBar.style.backgroundColor = '#4caf50';
            const formData = new FormData();
            formData.append('file', file);
            const xhr = new XMLHttpRequest();
            xhr.upload.addEventListener('progress', e => {
                if (e.lengthComputable) {
                    const percentComplete = Math.round((e.loaded / e.total) * 100);
                    progressBar.style.width = percentComplete + '%';
                    progressBar.textContent = percentComplete + '%';
                }
            });
            xhr.onload = () => {
                if (xhr.status === 200 || xhr.status === 302) {
                    uploadFileSequentially(files, index + 1);
                } else {
                    fileNameDisplay.textContent = `Gagal mengunggah ${file.name}`;
                    fileCountDisplay.textContent = `Proses dihentikan pada file ${index + 1}.`;
                    progressBar.style.backgroundColor = '#dc3545';
                    submitButton.disabled = false;
                    submitButton.textContent = 'Unggah File';
                }
            };
            xhr.onerror = () => {
                fileNameDisplay.textContent = 'Error jaringan. Periksa koneksi Anda.';
                progressBar.style.backgroundColor = '#dc3545';
                submitButton.disabled = false;
                submitButton.textContent = 'Unggah File';
            };
            xhr.open('POST', '/upload', true);
            xhr.send(formData);
        }

        form.addEventListener('submit', e => {
            e.preventDefault();
            const filesToUpload = fileInput.files;
            if (filesToUpload.length === 0) {
                alert('Silakan pilih file terlebih dahulu.');
                return;
            }
            submitButton.disabled = true;
            submitButton.textContent = 'Mengunggah...';
            uploadStatus.style.display = 'block';
            uploadFileSequentially(filesToUpload, 0);
        });
    </script>
</body>
</html>